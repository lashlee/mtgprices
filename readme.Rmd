---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

This is my work in progress for parsing MTG Goldfish pages to extract card prices.

```{r}
library(tidyverse,quietly = TRUE)
library(xml2)
library(reticulate)
library(devtools)
library(roxygen2)
options(tibble.print_max = 100, tibble.print_min = 100)
```

```{r}
load_all()
```

```{r}
card_name <- "Snapcaster Mage"
set <- "Innistrad"
data_dir <- "/home/john/data/mtg/"
```

```{r}
plot_card_price_history(card_name, set) %>% plot
```

```{r}
write_card_price_history(card_name = card_name, 
                         set = set,
                         directory = data_dir)
```

```{r}
use_python("/usr/bin/python3") #mtgsdk requires python3
mtgsdk <- import("mtgsdk")
```

```{r}
extract_card_info <- function(card) {
  if (!identical(class(card),c("mtgsdk.card.Card", "python.builtin.object")))
    stop("Input is not of the correct class, c(\"mtgsdk.card.Card\", \"python.builtin.object\").")
  list(name      = card$name,
       set_code  = card$set,
       set_name  = card$set_name,
       layout    = card$layout,
       name_list = card$names,
       number    = card$number)
}
```

```{r, eval=FALSE}
card_dat <- mtgsdk$Card$where(set_name='Innistrad')$all()
```

```{r, eval=FALSE}
card_dat_parsed <- card_dat %>% map(extract_card_info)
```

```{r, eval=FALSE}
save(card_dat_parsed, file = "cards.RData")
```

```{r, eval=FALSE}
write_tsv(card_dat_parsed, path = "cards.tsv")
```

Dealing with cards lacking normal layout:

```{r, eval=FALSE, echo=FALSE}
# This is just scratch work.
head(card_dat_parsed,1000) %>% keep(~!is.null(.x$name_list))
card_dat_parsed %>% keep(~(.x$name == "Nissa, Sage Animist"))
#card_dat_parsed %>% keep(~((.x$layout != "normal") & str_detect(.x$number,"^[0-9]+a")))
#card_dat_parsed %>% keep(~(.x$layout != "normal")) %>% keep(~str_detect(.x$number,"^[0-9]+$|^[0-9]+a$")) %>% length
foo <- card_dat_parsed %>% keep( ~ str_detect(.x$number,"^[0-9]+$|^[0-9]+a$"))
foo <- card_dat_parsed %>% keep( function(x) grepl("^[0-9]+$|^[0-9]+a$", x$number) )
foo <- card_dat_parsed %>% keep( ~ !is.na(as.numeric(.x$number)) )
```

```{r, eval = FALSE}
basic_lands <- c("Plains", "Island", "Swamp", "Mountain", "Forest")
```

```{r, eval=FALSE}
#This is broken until I can sort out Flip, Double Faced, etc. cards.
df <- card_dat %>% 
  sample_n(30) %>% 
  select(card_name = name, set = set_name) %>% 
  filter(!(card_name %in% basic_lands)) %>%
  mutate(set = case_when(set == "Magic: The Gathering-Commander"  ~ "Commander",
                         set == "Magic: The Gathering-Conspiracy" ~ "Conspiracy",
                         set == "Judge Gift Program"              ~ "Judge Promos",
                         set == "Prerelease Events"               ~ "Prerelease Cards",
                         TRUE                                     ~ set))
```

Flip cards are known broken, e.g. card named Harvest Hand.

```{rm, eval=FALSE}
#This is broken until I can sort out Flip, Double Faced, etc. cards.
df[2,] %>% 
  pmap( ~ write_card_price_history(card_name = ..1,
                                   set = ..2,
                                   directory = data_dir))
```











